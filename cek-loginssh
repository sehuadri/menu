#!/bin/bash
# =================================================================
#
#   SCRIPT CEK LOGIN PENGGUNA VPS (VERSI LENGKAP)
#   - Cek sesi SSH, Dropbear, OpenVPN
#   - Deteksi multi-login
#   - Daftar pengguna non-root yang aktif
#
#   Dibuat dan dioptimalkan oleh Gemini
#
# =================================================================

# --- Variabel Warna ---
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
ORANGE='\033[0;33m'

# --- Fungsi Bantuan ---
# Fungsi untuk mencetak header tabel agar rapi
print_header() {
    local text="$1"
    echo -e "${CYAN}┌───────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}│${WHITE} $text ${NC}"
    echo -e "${CYAN}├───────────────────────────────────────────────────┤${NC}"
}

# Fungsi untuk mencetak footer tabel
print_footer() {
    echo -e "${CYAN}└───────────────────────────────────────────────────┘${NC}"
}


# --- Mulai Skrip ---
clear
echo -e "${WHITE}===============================================${NC}"
echo -e "${CYAN}       MONITOR LOGIN PENGGUNA AKTIF       ${NC}"
echo -e "${WHITE}===============================================${NC}"
echo ""


# ====== 1. SESI LOGIN SSH & DROPBEAR AKTIF ======
print_header "Sesi SSH & Dropbear Aktif                  "
# Menggunakan 'w' adalah cara paling akurat untuk melihat sesi login
# tail -n +3 -> Melewati 2 baris header dari output 'w'
# awk -> Memformat output agar rapi dan terstruktur
# `who` juga bisa, tapi `w` memberikan info TTY (terminal) yang lebih jelas
if w | tail -n +3 | awk '{ printf "│ %-15s │ %-8s │ %-15s │\n", $1, $2, $3 }' | grep -q "│"; then
    w | tail -n +3 | awk '{
        printf "│ ${GREEN}%-15s${NC} │ %-8s │ ${ORANGE}%-15s${NC} │\n", $1, $2, $3
    }'
else
    echo -e "│ ${RED}Tidak ada sesi SSH/Dropbear yang aktif.${NC}        │"
fi
print_footer
echo ""


# ====== 2. SESI OPENVPN AKTIF ======
# Cek dari file status OpenVPN, bukan file log biasa
STATUS_FILE=$(ls /etc/openvpn/server/openvpn-status.log 2>/dev/null || ls /etc/openvpn/openvpn-status.log 2>/dev/null)

if [ -f "$STATUS_FILE" ]; then
    print_header "Sesi OpenVPN Aktif                         "
    # Ambil data dari bagian CLIENT LIST dan format dengan awk
    if sed -n '/CLIENT LIST/,/ROUTING TABLE/p' "$STATUS_FILE" | grep -vE "CLIENT LIST|ROUTING TABLE|Common Name" | grep -q ","; then
        sed -n '/CLIENT LIST/,/ROUTING TABLE/p' "$STATUS_FILE" | \
        grep -vE "CLIENT LIST|ROUTING TABLE|Common Name" | \
        awk -F',' '{
            # $1 = Common Name (Username), $2 = Real Address
            printf "│ ${GREEN}%-15s${NC} │ ${ORANGE}%-17s${NC} │\n", $1, $2
        }'
    else
        echo -e "│ ${RED}Tidak ada klien OpenVPN yang terhubung.${NC}         │"
    fi
    print_footer
    echo ""
fi


# ====== 3. DAFTAR PENGGUNA NON-ROOT YANG AKTIF ======
print_header "Pengguna Non-Root Aktif (Unik)             "
LOGGED_IN_USERS=$(who | awk '{print $1}' | grep -v '^root$' | sort -u)

if [ -n "$LOGGED_IN_USERS" ]; then
    # Ubah spasi menjadi baris baru, lalu format
    echo "$LOGGED_IN_USERS" | awk '{ printf "│ ${GREEN}%-45s${NC} │\n", $1 }'
else
    echo -e "│ ${RED}Tidak ada pengguna non-root yang login.${NC}        │"
fi
print_footer
echo ""


# ====== 4. PENGECEKAN MULTI-LOGIN ======
echo -e "${ORANGE}--- Pengecekan Multi-Login Sesi SSH/Dropbear ---${NC}"
# Cari pengguna yang muncul lebih dari sekali di output 'w'
w | tail -n +3 | awk '{print $1}' | sort | uniq -c | while read -r line; do
    count=$(echo "$line" | awk '{print $1}')
    user=$(echo "$line" | awk '{print $2}')
    if [ "$count" -gt 2 ]; then
        printf " ${RED}PERINGATAN:${NC} Pengguna ${ORANGE}%-15s${NC} memiliki ${RED}%s${NC} sesi aktif!\n" "$user" "$count"
    fi
done | {
    # Cek apakah ada output, jika tidak, cetak pesan sukses
    HAS_MULTILOGIN=$(cat)
    if [ -n "$HAS_MULTILOGIN" ]; then
        echo "$HAS_MULTILOGIN"
    else
        echo -e " ${GREEN}✔${NC} Tidak ditemukan adanya multi-login."
    fi
}
echo ""


# ====== Kembali ke Menu ======
# Baris ini sesuai dengan skrip-skrip menu VPS pada umumnya
read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu..."
# Ganti 'menu' dengan perintah menu utama Anda jika berbeda (misal: m-ssh)
menu
