#!/bin/bash
clear
# Warna
RED='\033[0;31m'
NC='\033[0m'
CYAN='\033[0;36m'

# Tentukan sumber log
if [ -e "/var/log/auth.log" ]; then
    LOG="/var/log/auth.log"
elif [ -e "/var/log/secure" ]; then
    LOG="/var/log/secure"
else
    journalctl -u dropbear -u ssh --no-pager > /tmp/auth.log
    LOG="/tmp/auth.log"
fi

echo -e "${CYAN}---------------------------------------------${NC}"
echo "       ID     |  Username    |  IP Address"
echo -e "${CYAN}---------------------------------------------${NC}"

# === DROPBEAR ===
data=( $(ps -eo pid,comm | grep dropbear | grep -v grep | awk '{print $1}') )
grep -i "Password auth succeeded" "$LOG" > /tmp/login-db.txt

for PID in "${data[@]}"; do
    grep "dropbear\[$PID\]" /tmp/login-db.txt > /tmp/login-db-pid.txt
    if [ -s /tmp/login-db-pid.txt ]; then
        USER=$(awk '{print $(NF-5)}' /tmp/login-db-pid.txt)
        IP=$(awk '{print $(NF-3)}' /tmp/login-db-pid.txt)
        echo "$PID - $USER - $IP"
    fi
done

# === SSH ===
echo -e "${CYAN}---------------------------------------------${NC}"
echo "       ID     |  Username    |  IP Address"
echo -e "${CYAN}---------------------------------------------${NC}"

data=( $(ps -eo pid,comm | grep sshd | grep -v grep | awk '{print $1}') )
grep "Accepted password for" "$LOG" > /tmp/login-ssh.txt

for PID in "${data[@]}"; do
    grep "sshd\[$PID\]" /tmp/login-ssh.txt > /tmp/login-ssh-pid.txt
    if [ -s /tmp/login-ssh-pid.txt ]; then
        USER=$(awk '{print $9}' /tmp/login-ssh-pid.txt)
        IP=$(awk '{print $11}' /tmp/login-ssh-pid.txt)
        echo "$PID - $USER - $IP"
    fi
done

# === OPENVPN TCP ===
for path in "/etc/openvpn/server/openvpn-tcp.log" "/var/log/openvpn-tcp.log"; do
    if [ -f "$path" ]; then
        echo -e "${CYAN}---------------------------------------------${NC}"
        echo "    Username  |  IP Address  |  Connected"
        echo -e "${CYAN}---------------------------------------------${NC}"
        grep -w "^CLIENT_LIST" "$path" | cut -d ',' -f 2,3,8 | sed 's/,/      /g'
    fi
done

# === OPENVPN UDP ===
for path in "/etc/openvpn/server/openvpn-udp.log" "/var/log/openvpn-udp.log"; do
    if [ -f "$path" ]; then
        echo -e "${CYAN}---------------------------------------------${NC}"
        echo "    Username  |  IP Address  |  Connected"
        echo -e "${CYAN}---------------------------------------------${NC}"
        grep -w "^CLIENT_LIST" "$path" | cut -d ',' -f 2,3,8 | sed 's/,/      /g'
    fi
done

echo -e "${CYAN}---------------------------------------------${NC}"
echo "";
echo ""
read -n 1 -s -r -p "Press any key to back on menu"
m-ssh
