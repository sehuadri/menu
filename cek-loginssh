#!/bin/bash
# Script Pengecekan Login Pengguna
# Diperbaiki dan dioptimalkan oleh Gemini
# ==========================================

clear
# ====== Colors ======
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
ORANGE='\033[0;33m'

# Fungsi untuk membuat header tabel
print_header() {
    echo -e "${CYAN}--------------------------------------------------${NC}"
    echo -e " ${WHITE}$1${NC}"
    echo -e "${CYAN}--------------------------------------------------${NC}"
}

# ====== SESI LOGIN SSH & DROPBEAR AKTIF ======
echo ""
print_header "ID  | Username        | IP Address"

# Menggunakan 'w' adalah cara paling akurat untuk melihat sesi login aktif
# tail -n +3 -> Melewati 2 baris header dari output 'w'
# awk -> Memformat output agar rapi dan terstruktur
w | tail -n +3 | awk '{
    printf " %-3s | %-15s | %s\n", $2, $1, $3
}'
echo -e "${CYAN}--------------------------------------------------${NC}"

# ====== SESI OPENVPN AKTIF ======
# Cek dari file status OpenVPN, bukan file log biasa
# File status berisi data real-time koneksi klien

# OpenVPN TCP
if [ -f /etc/openvpn/server/openvpn-status.log ] || [ -f /etc/openvpn/openvpn-status.log ]; then
    # Cari path file status yang benar
    STATUS_FILE=$(ls /etc/openvpn/server/openvpn-status.log 2>/dev/null || ls /etc/openvpn/openvpn-status.log 2>/dev/null)

    echo ""
    print_header "Username (VPN)  | IP Address        | Sejak"

    # Ambil data dari bagian CLIENT LIST
    sed -n '/CLIENT LIST/,/ROUTING TABLE/p' "$STATUS_FILE" | \
    grep -vE "CLIENT LIST|ROUTING TABLE|Common Name" | \
    awk -F',' '{
        # $1 = Common Name (Username), $2 = Real Address, $5 = Connected Since
        printf " %-15s | %-17s | %s\n", $1, $2, $5
    }'
    echo -e "${CYAN}--------------------------------------------------${NC}"
fi

# Cek Multi-Login untuk SSH/Dropbear
echo ""
echo -e "${ORANGE}--- Pengecekan Multi-Login ---${NC}"
w | tail -n +3 | awk '{print $1}' | sort | uniq -c | while read -r line; do
    count=$(echo "$line" | awk '{print $1}')
    user=$(echo "$line" | awk '{print $2}')
    if [ "$count" -gt 1 ]; then
        printf " ${RED}%-15s: %s sesi aktif!${NC}\n" "$user" "$count"
    fi
done
echo ""

# Kembali ke menu (seperti di skrip asli)
read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu..."
m-ssh
