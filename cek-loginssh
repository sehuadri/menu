#!/bin/bash
# Color
y='\033[1;33m'
f="\033[1;97;41m"
UK='\e[38;5;99m'  # Ungu
WHITE="\033[1;37m"
RED="\e[91;1m"
GREEN='\033[0;32m'
NC='\033[0m'

clear
echo " "
echo " "
echo -e "${UK}┌───────────────────────────────────────────────────┐${NC}"
echo -e "  ${WHITE}  Checking Logged-in SSH & Dropbear Users      ${NC}"
echo -e "${UK}└───────────────────────────────────────────────────┘${NC}"
echo ""
echo -e "${WHITE}  Username         |  IP Address          |  Login From Port${NC}"
echo -e "${UK}───────────────────────────────────────────────────${NC}"

# Menggunakan 'ss' untuk mendapatkan daftar koneksi yang sudah terhubung (established)
# pada semua port yang didefinisikan di skrip addssh.
# Port SSH: 22, 109
# Port WS: 80, 8080, 2086, 8880
# Port WSS/SSL: 443, 8443
ss -tnp state established \
'( sport = :22 or sport = :109 or sport = :80 or sport = :8080 or sport = :2086 or sport = :8880 or sport = :443 or sport = :8443 )' | \
awk '
BEGIN {
    FS="([[:space:]:]|users=)+"; OFS=" | "
}
NR>1 {
    # Ekstrak PID dari kolom terakhir
    gsub(/(\(|\"|,pid=|,fd=[0-9]+\)|\))/, "", $NF);
    pid = $NF;

    # Dapatkan nama pengguna dari PID
    cmd = "ps -o user= -p " pid;
    cmd | getline user;
    close(cmd);
    
    # Ambil IP Address dan Port
    ip = $(NF-3);
    port = $(NF-2);
    
    # Cetak output dengan format yang rapi jika nama pengguna ditemukan
    if (user != "" && user != "root") {
        printf "  %-16s |  %-20s |  %s\n", user, ip, port
    }
}'

echo -e "${UK}└───────────────────────────────────────────────────┘${NC}"
echo ""

# --- Bagian Pengecekan OpenVPN (Opsional, jika masih digunakan) ---
if [ -f "/etc/openvpn/server/openvpn-tcp.log" ] && grep -q -w "^CLIENT_LIST" /etc/openvpn/server/openvpn-tcp.log; then
    echo -e "${UK}┌───────────────────────────────────────────────────┐${NC}"
    echo -e "  ${WHITE}  Checking Logged-in OpenVPN TCP Users         ${NC}"
    echo -e "${UK}└───────────────────────────────────────────────────┘${NC}"
    echo ""
    echo -e "${WHITE}  Username         |  IP Address          |  Connected Since${NC}"
    echo -e "${UK}───────────────────────────────────────────────────${NC}"
    cat /etc/openvpn/server/openvpn-tcp.log | grep -w "^CLIENT_LIST" | cut -d ',' -f 2,3,8 | \
    awk 'BEGIN {FS=","; OFS=" | "} {printf "  %-16s |  %-20s |  %s\n", $1, $2, $3}'
    echo -e "${UK}└───────────────────────────────────────────────────┘${NC}"
    echo ""
fi

if [ -f "/etc/openvpn/server/openvpn-udp.log" ] && grep -q -w "^CLIENT_LIST" /etc/openvpn/server/openvpn-udp.log; then
    echo -e "${UK}┌───────────────────────────────────────────────────┐${NC}"
    echo -e "  ${WHITE}  Checking Logged-in OpenVPN UDP Users         ${NC}"
    echo -e "${UK}└───────────────────────────────────────────────────┘${NC}"
    echo ""
    echo -e "${WHITE}  Username         |  IP Address          |  Connected Since${NC}"
    echo -e "${UK}───────────────────────────────────────────────────${NC}"
    cat /etc/openvpn/server/openvpn-udp.log | grep -w "^CLIENT_LIST" | cut -d ',' -f 2,3,8 | \
    awk 'BEGIN {FS=","; OFS=" | "} {printf "  %-16s |  %-20s |  %s\n", $1, $2, $3}'
    echo -e "${UK}└───────────────────────────────────────────────────┘${NC}"
    echo ""
fi


read -n 1 -s -r -p "Press any key to back on menu"
m-ssh
