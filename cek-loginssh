#!/bin/bash
clear

# --- Variabel Warna ---
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'

# --- Membersihkan Layar ---
clear
echo " "
echo " "

# --- Deteksi File Log Otomatis ---
if [ -e "/var/log/auth.log" ]; then
    LOG="/var/log/auth.log"
elif [ -e "/var/log/secure" ]; then
    LOG="/var/log/secure"
else
    echo "File log otentikasi tidak ditemukan."
    exit 1
fi

# =================================================================
#                 RIWAYAT LOGIN DROPBEAR
# =================================================================
# Script lama dihapus karena logika PID-nya salah.
# Script baru langsung mem-parsing log tanpa mencocokkan PID.
# Ini menunjukkan riwayat login, bukan sesi yang sedang aktif.
echo -e "${CYAN}--------------------------------------------------${NC}"
echo -e "       ${LIGHT}RIWAYAT LOGIN DROPBEAR (dari Log)${NC}"
echo -e "${CYAN}--------------------------------------------------${NC}"
echo -e "      Username         |  IP Address"
echo -e "${CYAN}--------------------------------------------------${NC}"
grep -i "dropbear" $LOG | grep -i "Password auth succeeded" | awk '{
    user=$10
    ip=$12
    # Membersihkan tanda kutip dari username
    gsub(/\047/, "", user)
    # Membersihkan port dari IP
    sub(/:[0-9]+$/, "", ip)
    # Cetak dengan format agar rapi
    printf "  %-18s |  %s\n", user, ip
}'
echo -e "${CYAN}--------------------------------------------------${NC}"
echo " "


# =================================================================
#                 RIWAYAT LOGIN OpenSSH (sshd)
# =================================================================
# Script lama juga diperbaiki karena punya masalah logika yang sama.
# Ini menunjukkan riwayat login, bukan sesi yang sedang aktif.
echo -e "${CYAN}--------------------------------------------------${NC}"
echo -e "       ${LIGHT}RIWAYAT LOGIN SSHD (dari Log)${NC}"
echo -e "${CYAN}--------------------------------------------------${NC}"
echo -e "      Username         |  IP Address"
echo -e "${CYAN}--------------------------------------------------${NC}"
grep -i "sshd" $LOG | grep -i "Accepted password for" | awk '{
    user=$9
    ip=$11
    # Cetak dengan format agar rapi
    printf "  %-18s |  %s\n", user, ip
}'
echo -e "${CYAN}--------------------------------------------------${NC}"
echo " "


# =================================================================
#                 PENGGUNA AKTIF OPENVPN (TCP)
# =================================================================
# Bagian ini sudah benar dan tidak diubah.
if [ -f "/etc/openvpn/server/openvpn-tcp.log" ]; then
    echo -e "${CYAN}--------------------------------------------------${NC}"
    echo -e "         ${LIGHT}PENGGUNA AKTIF OPENVPN (TCP)${NC}"
    echo -e "${CYAN}--------------------------------------------------${NC}"
    echo -e "  Username      |  IP Address       |  Connected Since"
    echo -e "${CYAN}--------------------------------------------------${NC}"
    # Menggunakan printf untuk format yang lebih konsisten
    cat /etc/openvpn/server/openvpn-tcp.log | grep -w "^CLIENT_LIST" | cut -d ',' -f 2,3,8 | while IFS=, read -r user ip connected; do
        printf "  %-13s |  %-15s  |  %s\n" "$user" "$ip" "$connected"
    done
    echo -e "${CYAN}--------------------------------------------------${NC}"
    echo " "
fi


# =================================================================
#                 PENGGUNA AKTIF OPENVPN (UDP)
# =================================================================
# Bagian ini sudah benar dan tidak diubah.
if [ -f "/etc/openvpn/server/openvpn-udp.log" ]; then
    echo -e "${CYAN}--------------------------------------------------${NC}"
    echo -e "         ${LIGHT}PENGGUNA AKTIF OPENVPN (UDP)${NC}"
    echo -e "${CYAN}--------------------------------------------------${NC}"
    echo -e "  Username      |  IP Address       |  Connected Since"
    echo -e "${CYAN}--------------------------------------------------${NC}"
    cat /etc/openvpn/server/openvpn-udp.log | grep -w "^CLIENT_LIST" | cut -d ',' -f 2,3,8 | while IFS=, read -r user ip connected; do
        printf "  %-13s |  %-15s  |  %s\n" "$user" "$ip" "$connected"
    done
    echo -e "${CYAN}--------------------------------------------------${NC}"
    echo " "
fi


# --- Footer ---
echo ""
read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu..."
m-ssh
