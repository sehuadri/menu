#!/bin/bash
# Color
y='\033[1;33m'
f="\033[1;97;41m"
UK='\e[38;5;99m'  # ungu
WHITE="\033[1;37m"
RED="\e[91;1m"
GREEN='\033[0;32m'
NC='\033[0m'

clear
echo " "
echo " "
echo -e "${UK}┌───────────────────────────────────────────────────┐${NC}"
echo -e "  ${WHITE}  Checking Logged-in SSH & Dropbear Users      ${NC}"
echo -e "${UK}└───────────────────────────────────────────────────┘${NC}"
echo ""
echo -e "${WHITE}  Username         |  IP Address          |  Login Time${NC}"
echo -e "${UK}───────────────────────────────────────────────────${NC}"

# Menggunakan ss untuk mendapatkan koneksi SSH (OpenSSH & Dropbear)
# Port 22 untuk OpenSSH, Port 109, 22 untuk Dropbear (sesuai skrip addssh)
ss -tnp state established '( dport = :22 or dport = :109 )' | \
awk '
BEGIN {
    FS=":[0-9]+ +"; OFS=" | "
}
NR>1 {
    split($4, ip, ":");
    gsub(/users=\(\("|\",pid=[0-9]+,fd=[0-9]+\)\)/, "", $5);
    # Mencari nama pengguna dari proses
    cmd = "ps -o user= -p " substr($5, index($5, "=") + 1)
    cmd | getline user;
    close(cmd);
    
    # Mencari waktu login
    cmd = "who -u | grep " user " | awk '\''{print $3, $4}'\'' | head -n 1"
    cmd | getline logintime
    close(cmd)

    # Mencetak output dengan format
    if (user != "") {
        printf "  %-16s |  %-20s |  %s\n", user, ip[1], logintime
    }
}'

echo -e "${UK}└───────────────────────────────────────────────────┘${NC}"
echo ""
read -n 1 -s -r -p "Press any key to back on menu"
m-ssh
