#!/bin/bash
# ====== Color ======
y='\033[1;33m'
f="\033[1;97;41m"
UK='\e[38;5;99m'  # ungu
WHITE="\033[1;37m"
RED="\e[91;1m"
GREEN='\033[0;32m'
NC='\033[0m'
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
clear
echo " "
echo " "

# Reload service
systemctl reload ssh >/dev/null 2>&1 || systemctl reload sshd >/dev/null 2>&1

# Deteksi file log
if [ -e "/var/log/auth.log" ]; then
    LOG="/var/log/auth.log"
elif [ -e "/var/log/secure" ]; then
    LOG="/var/log/secure"
else
    echo -e "${RED}Log auth tidak ditemukan!${NC}"
    exit 1
fi

# ====== DROPBEAR LOGIN ======
data=( $(ps aux | grep -i '[d]ropbear' | awk '{print $2}') )
echo -e "${UK}┌──────────────────────────────────────────┐${NC}"
echo -e "  ${WHITE}  ID  |  Username  |  IP Address ${NC}"
echo -e "${UK}└──────────────────────────────────────────┘${NC}"

grep -i dropbear "$LOG" | grep -i "Password auth succeeded" > /tmp/login-db.txt

for PID in "${data[@]}"; do
    grep "dropbear\[$PID\]" /tmp/login-db.txt > /tmp/login-db-pid.txt
    NUM=$(wc -l < /tmp/login-db-pid.txt)
    USER=$(awk -F"for " '{print $2}' /tmp/login-db-pid.txt | awk '{print $1}' | head -n1)
    IP=$(awk -F"for " '{print $2}' /tmp/login-db-pid.txt | awk '{print $3}' | head -n1)
    if [ "$NUM" -ge 1 ]; then
        echo -e "${WHITE}$PID - $USER - $IP${NC}"
    fi
done
echo -e "${UK}└──────────────────────────────────────────┘${NC}"

# ====== SSH LOGIN ======
echo " "
echo -e "${UK}┌──────────────────────────────────────────┐${NC}"
echo -e "  ${WHITE}  ID  |  Username  |  IP Address ${NC}"
echo -e "${UK}└──────────────────────────────────────────┘${NC}"

grep -i sshd "$LOG" | grep -i "Accepted password for" > /tmp/login-ssh.txt
data=( $(ps -o pid,cmd -C sshd | grep "\[priv\]" | awk '{print $1}') )

for PID in "${data[@]}"; do
    grep "sshd\[$PID\]" /tmp/login-ssh.txt > /tmp/login-ssh-pid.txt
    NUM=$(wc -l < /tmp/login-ssh-pid.txt)
    USER=$(awk -F"for " '{print $2}' /tmp/login-ssh-pid.txt | awk '{print $1}' | head -n1)
    IP=$(awk -F"for " '{print $2}' /tmp/login-ssh-pid.txt | awk '{print $3}' | head -n1)
    if [ "$NUM" -ge 1 ]; then
        echo -e "${WHITE}$PID - $USER - $IP${NC}"
    fi
done
echo -e "${UK}└──────────────────────────────────────────┘${NC}"

# ====== OPENVPN TCP ======
if [ -f "/etc/openvpn/server/openvpn-tcp.log" ]; then
    echo ""
    echo -e "${UK}┌──────────────────────────────────────────┐${NC}"
    echo -e "  ${WHITE}  Username  |  IP Address  |  Connected ${NC}"
    echo -e "${UK}└──────────────────────────────────────────┘${NC}"
    grep -w "^CLIENT_LIST" /etc/openvpn/server/openvpn-tcp.log | cut -d ',' -f 2,3,8 | sed -e 's/,/      /g'
    echo -e "${UK}└──────────────────────────────────────────┘${NC}"
fi

# ====== OPENVPN UDP ======
if [ -f "/etc/openvpn/server/openvpn-udp.log" ]; then
    echo ""
    echo -e "${UK}┌──────────────────────────────────────────┐${NC}"
    echo -e "  ${WHITE}  Username  |  IP Address  |  Connected ${NC}"
    echo -e "${UK}└──────────────────────────────────────────┘${NC}"
    grep -w "^CLIENT_LIST" /etc/openvpn/server/openvpn-udp.log | cut -d ',' -f 2,3,8 | sed -e 's/,/      /g'
    echo -e "${UK}└──────────────────────────────────────────┘${NC}"
fi
echo -e "\033[1;36m---------------------------------------------\033[0m"
echo "";
echo ""
read -n 1 -s -r -p "Press any key to back on menu"
m-ssh
